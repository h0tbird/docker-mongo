#!/bin/bash

#-----------------------------------------------------------------------------
# Configure the service:
#-----------------------------------------------------------------------------

: ${ETCD_PATH:=/mongo}

#-----------------------------------------------------------------------------
# Functions:
#-----------------------------------------------------------------------------

function token() {

  while true; do

    TKN=$(etcdctl get ${ETCD_PATH}/token 2>/dev/null); [ "$?" -eq 4 ] && {
    etcdctl mk ${ETCD_PATH}/token '0' &>/dev/null || { sleep 1; continue; }
    } || { [ "${TKN}" != 0 ] && return 1; }

    etcdctl set --swap-with-value '0' ${ETCD_PATH}/token '1' &>/dev/null && return 0
    sleep 1

  done
}

#-----------------------------------------------------------------------------
# Get the bootstrap token:
#-----------------------------------------------------------------------------

token && {
  echo "Do something..."
}

#-----------------------------------------------------------------------------
# Run:
#-----------------------------------------------------------------------------

exec mongod "$@"
